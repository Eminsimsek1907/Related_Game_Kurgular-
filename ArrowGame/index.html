<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OkÃ§uluk Oyunu</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/MotionPathPlugin.min.js"></script>
</head>

<body>
  <script>
    (function () {
      if (document.getElementById("okculuk-baslat-btn")) return;

      const styleSheet = document.createElement("style");
      styleSheet.innerHTML = `
          #okculuk-baslat-btn {
              position: fixed;
              bottom: 30px;
              right: 30px;
              width: 75px;
              height: 75px;
              background: linear-gradient(135deg, #ff416c, #ff4b2b);
              border-radius: 50%;
              box-shadow: 0 4px 15px rgba(255, 65, 108, 0.6);
              cursor: pointer;
              display: flex;
              justify-content: center;
              align-items: center;
              z-index: 999999;
              transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
              animation: pulse-btn 2s infinite;
              -webkit-tap-highlight-color: transparent;
              border: 2px solid rgba(255,255,255,0.2);
          }
          #okculuk-baslat-btn:hover {
              transform: scale(1.1) rotate(-5deg);
          }
          #okculuk-baslat-btn:active {
              transform: scale(0.95);
          }

          #okculuk-baslat-btn svg {
              width: 38px;
              height: 38px;
              fill: white;
              pointer-events: none;
              filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2));
          }

          .okculuk-tooltip {
              position: absolute;
              right: 90px;
              background: #fff0f3;
              color: #d63031;
              padding: 8px 12px;
              border-radius: 20px;
              font-family: sans-serif;
              font-size: 14px;
              font-weight: bold;
              opacity: 0;
              visibility: hidden;
              transition: 0.3s;
              white-space: nowrap;
              pointer-events: none;
              box-shadow: 0 5px 15px rgba(0,0,0,0.15);
              border: 1px solid #ffccd5;
          }
          .okculuk-tooltip::after {
              content: '';
              position: absolute;
              top: 50%;
              right: -6px;
              margin-top: -6px;
              border-width: 6px;
              border-style: solid;
              border-color: transparent transparent transparent #fff0f3;
          }
          #okculuk-baslat-btn:hover .okculuk-tooltip {
              opacity: 1;
              visibility: visible;
              right: 85px;
          }

          @keyframes pulse-btn {
              0% { box-shadow: 0 0 0 0 rgba(255, 65, 108, 0.7); }
              70% { box-shadow: 0 0 0 20px rgba(255, 65, 108, 0); }
              100% { box-shadow: 0 0 0 0 rgba(255, 65, 108, 0); }
          }
      `;
      document.head.appendChild(styleSheet);

      const startBtn = document.createElement("div");
      startBtn.id = "okculuk-baslat-btn";
      startBtn.innerHTML = `
          <span class="okculuk-tooltip">ðŸ’˜ Hedefi 12'den Vur, Ä°ndirimi Kap!</span>
          <svg viewBox="0 0 24 24">
              <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
          </svg>
      `;
      document.body.appendChild(startBtn);

      startBtn.onclick = function () {
        startBtn.style.display = "none";
        if (window.gsap && window.MotionPathPlugin) {
          gsap.registerPlugin(MotionPathPlugin);
        }
        initGameEngine();
      };

      function initGameEngine() {
        const overlayId = "okculuk-oyunu-overlay";
        if (document.getElementById(overlayId)) return;

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const masterGain = audioCtx.createGain();
        masterGain.gain.value = 1;
        masterGain.connect(audioCtx.destination);

        const bufferSize = audioCtx.sampleRate * 2;
        const noiseBuffer = audioCtx.createBuffer(
          1,
          bufferSize,
          audioCtx.sampleRate
        );
        const output = noiseBuffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) {
          output[i] = Math.random() * 2 - 1;
        }

        function playSound(type) {
          if (audioCtx.state === "suspended") audioCtx.resume();
          const now = audioCtx.currentTime;
          const gainNode = audioCtx.createGain();
          gainNode.connect(masterGain);

          if (type === "shoot") {
            const noise = audioCtx.createBufferSource();
            noise.buffer = noiseBuffer;
            const filter = audioCtx.createBiquadFilter();
            filter.type = "lowpass";
            filter.frequency.setValueAtTime(800, now);
            filter.frequency.exponentialRampToValueAtTime(100, now + 0.2);
            noise.connect(filter);
            filter.connect(gainNode);
            gainNode.gain.setValueAtTime(0.6, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
            noise.start(now);
            noise.stop(now + 0.2);
          } else if (type === "hit") {
            const osc = audioCtx.createOscillator();
            osc.type = "triangle";
            osc.frequency.setValueAtTime(150, now);
            osc.frequency.exponentialRampToValueAtTime(40, now + 0.08);
            gainNode.gain.setValueAtTime(0.8, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.08);
            osc.connect(gainNode);
            osc.start(now);
            osc.stop(now + 0.08);
          } else if (type === "miss") {
            const osc = audioCtx.createOscillator();
            osc.type = "sawtooth";
            osc.frequency.setValueAtTime(800, now);
            osc.frequency.exponentialRampToValueAtTime(100, now + 0.2);
            gainNode.gain.setValueAtTime(0.05, now);
            gainNode.gain.linearRampToValueAtTime(0, now + 0.2);
            osc.connect(gainNode);
            osc.start(now);
            osc.stop(now + 0.2);
          } else if (type === "win") {
            const notes = [523.25, 659.25, 783.99, 1046.5];
            notes.forEach((freq, i) => {
              const osc = audioCtx.createOscillator();
              osc.type = "sine";
              osc.frequency.value = freq;
              const noteGain = audioCtx.createGain();
              noteGain.connect(masterGain);
              const startTime = now + 0.1 + i * 0.08;
              noteGain.gain.setValueAtTime(0, startTime);
              noteGain.gain.linearRampToValueAtTime(0.1, startTime + 0.05);
              noteGain.gain.exponentialRampToValueAtTime(0.01, startTime + 0.8);
              osc.connect(noteGain);
              osc.start(startTime);
              osc.stop(startTime + 1);
            });
          }
        }

        const style = document.createElement("style");
        style.innerHTML = `
              #rotate-message { display: none; }
              @media screen and (orientation: portrait) and (max-width: 1024px) {
                  #game-wrapper { display: none !important; }
                  #rotate-message { display: flex !important; }
              }
              @media screen and (max-width: 768px) {
                  #close-game-btn-main { padding: 15px 30px !important; font-size: 16px !important; }
                  #mute-btn-main { width: 50px !important; height: 50px !important; }
              }
          `;
        document.head.appendChild(style);

        const overlay = document.createElement("div");
        overlay.id = overlayId;
        Object.assign(overlay.style, {
          position: "fixed",
          top: "0",
          left: "0",
          width: "100vw",
          height: "100vh",
          backgroundColor: "#1a1a1a",
          zIndex: "9999999",
          display: "flex",
          justifyContent: "center",
          alignItems: "center",
          overflow: "hidden",
          fontFamily: '"Segoe UI", Tahoma, Geneva, Verdana, sans-serif',
          userSelect: "none",
          webkitUserSelect: "none",
          touchAction: "none",
        });

        const rotateMsg = document.createElement("div");
        rotateMsg.id = "rotate-message";
        Object.assign(rotateMsg.style, {
          position: "absolute",
          top: 0,
          left: 0,
          width: "100%",
          height: "100%",
          backgroundColor: "rgb(26 26 26)",
          color: "white",
          zIndex: "20000001",
          flexDirection: "column",
          justifyContent: "center",
          alignItems: "center",
          textAlign: "center",
          padding: "20px",
        });
        rotateMsg.innerHTML = `
              <svg fill="white" width="80" height="80" viewBox="0 0 24 24" style="margin-bottom:20px; animation: spin 2s infinite ease-in-out;">
                  <path d="M16.48 2.52c3.27 1.55 5.61 4.72 5.97 8.48h1.5C23.44 4.84 18.29 0 12 0l-.66.03 3.81 3.81 1.33-1.32zm-6.25-.77c-.59-.59-1.54-.59-2.12 0L1.75 8.11c-.59.59-.59 1.54 0 2.12l12.02 12.02c.59.59 1.54.59 2.12 0l6.36-6.36c.59-.59.59-1.54 0-2.12L10.23 1.75zm4.6 19.44L2.81 9.17l6.36-6.36 12.02 12.02-6.36 6.36z"/>
              </svg>
              <h2 style="margin:0;">LÃ¼tfen Telefonu Yan Ã‡evirin</h2>
              <p>Oyun sadece yatay modda oynanabilir.</p>
          `;
        const animStyle = document.createElement("style");
        animStyle.innerHTML = `@keyframes spin { 0% { transform: rotate(0deg); } 25% { transform: rotate(-90deg); } 100% { transform: rotate(-90deg); } }`;
        document.head.appendChild(animStyle);
        overlay.appendChild(rotateMsg);

        const gameWrapper = document.createElement("div");
        gameWrapper.id = "game-wrapper";
        gameWrapper.style.width = "100%";
        gameWrapper.style.height = "100%";
        gameWrapper.style.position = "relative";
        overlay.appendChild(gameWrapper);

        const closeGameFn = () => {
          if (overlay.parentNode) document.body.removeChild(overlay);
          window.removeEventListener("mousedown", window.gameDrawFn);
          window.removeEventListener("mousemove", window.gameAimFn);
          window.removeEventListener("mouseup", window.gameLooseFn);
          window.removeEventListener("touchstart", window.gameDrawFn);
          window.removeEventListener("touchmove", window.gameAimFn);
          window.removeEventListener("touchend", window.gameLooseFn);
          const btn = document.getElementById("okculuk-baslat-btn");
          if (btn) btn.style.display = "flex";
        };

        const closeBtn = document.createElement("button");
        closeBtn.id = "close-game-btn-main";
        closeBtn.innerText = "Ã‡IKIÅž";
        Object.assign(closeBtn.style, {
          position: "absolute",
          top: "20px",
          right: "20px",
          zIndex: "10000000",
          padding: "10px 25px",
          background: "#e74c3c",
          color: "white",
          border: "none",
          cursor: "pointer",
          fontSize: "14px",
          fontWeight: "bold",
          borderRadius: "5px",
          boxShadow: "0 4px 0 #c0392b",
          userSelect: "none",
        });
        closeBtn.onclick = closeGameFn;
        closeBtn.ontouchend = (e) => {
          e.preventDefault();
          closeGameFn();
        };
        gameWrapper.appendChild(closeBtn);

        const muteBtn = document.createElement("div");
        muteBtn.id = "mute-btn-main";
        let isMuted = false;
        const iconSound = `<svg fill="white" width="24" height="24" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>`;
        const iconMute = `<svg fill="white" width="24" height="24" viewBox="0 0 24 24"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73 4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>`;
        Object.assign(muteBtn.style, {
          position: "absolute",
          bottom: "20px",
          left: "20px",
          zIndex: "10000000",
          width: "40px",
          height: "40px",
          background: "rgba(255,255,255,0.1)",
          borderRadius: "50%",
          cursor: "pointer",
          display: "flex",
          justifyContent: "center",
          alignItems: "center",
          transition: "background 0.3s",
        });
        muteBtn.innerHTML = iconSound;
        const toggleMute = (e) => {
          if (e) e.stopPropagation();
          isMuted = !isMuted;
          if (isMuted) {
            masterGain.gain.setValueAtTime(0, audioCtx.currentTime);
            muteBtn.innerHTML = iconMute;
          } else {
            masterGain.gain.setValueAtTime(1, audioCtx.currentTime);
            if (audioCtx.state === "suspended") audioCtx.resume();
            muteBtn.innerHTML = iconSound;
          }
        };
        muteBtn.onclick = toggleMute;
        muteBtn.ontouchend = (e) => {
          e.preventDefault();
          toggleMute(e);
        };
        gameWrapper.appendChild(muteBtn);

        let score = 0;
        const scoreBoard = document.createElement("div");
        Object.assign(scoreBoard.style, {
          position: "absolute",
          top: "20px",
          left: "20px",
          zIndex: "10000000",
          color: "white",
          fontSize: "24px",
          fontWeight: "bold",
          pointerEvents: "none",
          userSelect: "none",
        });

        scoreBoard.innerHTML = `Puan: <span id="game-score">0</span> / 3`;
        gameWrapper.appendChild(scoreBoard);

        const modalOverlay = document.createElement("div");
        Object.assign(modalOverlay.style, {
          position: "absolute",
          top: "0",
          left: "0",
          width: "100%",
          height: "100%",
          backgroundColor: "rgba(0,0,0,0.8)",
          zIndex: "20000000",
          display: "none",
          justifyContent: "center",
          alignItems: "center",
          flexDirection: "column",
        });

        const modalContent = document.createElement("div");
        Object.assign(modalContent.style, {
          backgroundColor: "white",
          padding: "40px",
          borderRadius: "15px",
          textAlign: "center",
          width: "90%",
          maxWidth: "400px",
          boxShadow: "0 10px 25px rgba(0,0,0,0.5)",
          fontFamily: "sans-serif",
        });

        modalContent.innerHTML = `
              <h2 style="color:#2ecc71; margin-top:0; font-size:32px;">TEBRÄ°KLER!</h2>
              <p style="color:#333; font-size:18px; margin-bottom:20px;">3 PuanÄ± topladÄ±n ve<br><strong>250 TL Ä°ndirim Kuponu</strong> kazandÄ±n!</p>
              <div style="background:#f1f2f6; border:2px dashed #bdc3c7; padding:15px; font-size:24px; font-weight:bold; letter-spacing:2px; color:#2c3e50; margin-bottom:20px; border-radius:8px;" id="coupon-code">250indirim</div>
              <button id="copy-btn" style="background:#f39c12; color:white; border:none; padding:12px 30px; font-size:16px; font-weight:bold; border-radius:50px; cursor:pointer; width:100%; transition:transform 0.2s;">KODU KOPYALA</button>
              <button id="close-game-btn-modal" style="background:transparent; color:#7f8c8d; border:none; margin-top:15px; cursor:pointer; font-size:14px; text-decoration:underline;">Oyunu Kapat</button>
          `;
        modalOverlay.appendChild(modalContent);
        gameWrapper.appendChild(modalOverlay);

        const copyBtn = modalContent.querySelector("#copy-btn");
        const closeGameBtn = modalContent.querySelector("#close-game-btn-modal");
        const copyCode = () => {
          const tempInput = document.createElement("input");
          tempInput.value = "250indirim";
          document.body.appendChild(tempInput);
          tempInput.select();
          document.execCommand("copy");
          document.body.removeChild(tempInput);
          copyBtn.innerText = "KOPYALANDI!";
          copyBtn.style.background = "#27ae60";
        };
        copyBtn.onclick = copyCode;
        copyBtn.ontouchend = (e) => {
          e.preventDefault();
          copyCode();
        };
        closeGameBtn.onclick = closeGameFn;
        closeGameBtn.ontouchend = (e) => {
          e.preventDefault();
          closeGameFn();
        };

        const feedbackOverlay = document.createElement("div");
        Object.assign(feedbackOverlay.style, {
          position: "absolute",
          top: "40%",
          left: "50%",
          transform: "translate(-50%, -50%)",
          zIndex: "100",
          pointerEvents: "none",
          textAlign: "center",
          userSelect: "none",
        });
        feedbackOverlay.innerHTML = `<h1 id="feedback-text" style="font-size: 80px; margin:0; opacity:0; text-shadow: 2px 2px 0 #000;"></h1>`;
        gameWrapper.appendChild(feedbackOverlay);

        const gameContainer = document.createElement("div");
        gameContainer.style.width = "100%";
        gameContainer.style.height = "100%";

        gameContainer.innerHTML = `
          <svg id="game-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 400" style="width:100%; height:100%; overflow:visible;">
      <linearGradient id="ArcGradient">
          <stop offset="0" stop-color="#fff" stop-opacity=".2"/>
          <stop offset="50%" stop-color="#fff" stop-opacity="0"/>
      </linearGradient>
      <path id="arc" fill="none" stroke="url(#ArcGradient)" stroke-width="4" d="M100,250c250-400,550-400,800,0" pointer-events="none"/>
      <defs>
          <g id="arrow">
              <line x2="60" fill="none" stroke="#d4a195" stroke-width="2" />
              <polygon fill="#FFD700" points="64 0 58 2 56 0 58 -2" />
              <polygon fill="#FFD700" points="2 -3 -4 -3 -1 0 -4 3 2 3 5 0" />
          </g>
          <clipPath id="cut-arrow-tip">
               <rect x="-10" y="-10" width="50" height="20" />
          </clipPath>
      </defs>

      <g id="target" transform="translate(0, -70) rotate(10, 710, 280)">
          <g transform="translate(24, 10)" opacity="0.5">
               <path fill="#A4330C" d="M902,220 c-20-20 -50-10 -60,10 c-10-20 -40-30 -60,-10 c-20,20 -20,50 0,70 l60,60 l60,-60 c20,-20 20,-50 0,-70 Z" />
          </g>

          <path fill="#FFF" d="M902,220 c-20-20 -50-10 -60,10 c-10-20 -40-30 -60,-10 c-20,20 -20,50 0,70 l60,60 l60,-60 c20,-20 20,-50 0,-70 Z" />

          <g transform="translate(-7, -3)">
              <path fill="#F4531C" d="M890,230 c-16-16 -40-8 -48,8 c-8-16 -32-24 -48,-8 c-16,16 -16,40 0,56 l48,48 l48,-48 c16,-16 16,-40 0,-56 Z" />
          </g>
          <g transform="translate(-14, -6)">
              <path fill="#FFF" d="M878,240 c-12-12 -30-6 -36,6 c-6-12 -24-18 -36,-6 c-12,12 -12,30 0,42 l36,36 l36,-36 c12,-12 12,-30 0,-42 Z" />
          </g>
          <g transform="translate(-21, -9)">
               <path fill="#F4531C" d="M866,250 c-8-8 -20-4 -24,4 c-4-8 -16-12 -24,-4 c-8,8 -8,20 0,28 l24,24 l24,-24 c8,-8 8,-20 0,-28 Z" />
          </g>
      </g>

      <g id="bow" fill="none" stroke-linecap="round" vector-effect="non-scaling-stroke" pointer-events="none">
          <polyline fill="none" stroke="#ecf0f1" stroke-linecap="round" points="88,200 88,250 88,300"/>
          <path fill="none" stroke="#FFD700" stroke-width="3" stroke-linecap="round" d="M88,300 c0-10.1,12-25.1,12-50s-12-39.9-12-50"/>
      </g>
      <g class="arrow-angle"><use x="100" y="250" href="#arrow"/></g>
      <clipPath id="mask">
          <polygon opacity=".5" points="0,0 1500,0 1500,200 970,290 950,240 925,220 875,280 890,295 920,310 0,350" pointer-events="none"/>
      </clipPath>
      <g class="arrows" clip-path="url(#mask)" pointer-events="none"></g>
  </svg>
          <div style="position:absolute; bottom:30px; left:0; width:100%; text-align:center; color:rgba(255,255,255,0.4); pointer-events:none; user-select:none;">
              Yay'Ä± germek iÃ§in basÄ±lÄ± tut, niÅŸan al, fÄ±rlatmak iÃ§in bÄ±rak!
          </div>
          `;
        gameWrapper.appendChild(gameContainer);
        document.body.appendChild(overlay);

        const svg = gameContainer.querySelector("#game-svg");
        initGameLogic(svg, overlay, scoreBoard, feedbackOverlay, modalOverlay, modalContent);

        function initGameLogic(
          svg,
          overlayEl,
          scoreElContainer,
          feedbackTextContainer,
          modalOverlay,
          modalContent
        ) {
          const cursor = svg.createSVGPoint();
          const arrowsGroup = overlayEl.querySelector(".arrows");
          const scoreEl = document.getElementById("game-score");
          const feedbackText = document.getElementById("feedback-text");
          let randomAngle = 0;
          let prizeWon = false;

          const target = { x: 830, y: 190 };
          const lineSegment = { x1: 820, y1: 250, x2: 830, y2: 190 };
          const pivot = { x: 100, y: 250 };

          aim({
            clientX: window.innerWidth * 0.3,
            clientY: window.innerHeight * 0.5,
          });

          window.gameDrawFn = draw;
          window.gameAimFn = aim;
          window.gameLooseFn = loose;

          window.addEventListener("mousedown", window.gameDrawFn);
          window.addEventListener("touchstart", window.gameDrawFn, {
            passive: false,
          });

          function draw(e) {
            if (
              e.target === closeBtn ||
              e.target === muteBtn ||
              muteBtn.contains(e.target) ||
              prizeWon ||
              e.target.id === "copy-btn" ||
              e.target.id === "close-game-btn-modal"
            )
              return;

            randomAngle = Math.random() * Math.PI * 0.03 - 0.015;
            gsap.to(".arrow-angle use", { duration: 0.3, opacity: 1 });

            window.addEventListener("mousemove", window.gameAimFn);
            window.addEventListener("mouseup", window.gameLooseFn);
            window.addEventListener("touchmove", window.gameAimFn, {
              passive: false,
            });
            window.addEventListener("touchend", window.gameLooseFn);
            aim(e);
          }

          function aim(e) {
            if (prizeWon) return;
            if (e.preventDefault && e.type === "touchmove") e.preventDefault();

            const point = getMouseSVG(e);
            point.x = Math.min(point.x, pivot.x - 7);
            point.y = Math.max(point.y, pivot.y + 7);

            const dx = point.x - pivot.x;
            const dy = point.y - pivot.y;
            const angle = Math.atan2(dy, dx) + randomAngle;
            const bowAngle = angle - Math.PI;
            const distance = Math.min(Math.sqrt(dx * dx + dy * dy), 50);
            const scale = Math.min(Math.max(distance / 30, 1), 2);

            gsap.to("#bow", {
              duration: 0.3,
              scaleX: scale,
              rotation: bowAngle + "rad",
              transformOrigin: "right center",
            });
            gsap.to(".arrow-angle", {
              duration: 0.3,
              rotation: bowAngle + "rad",
              svgOrigin: "100 250",
            });
            gsap.to(".arrow-angle use", { duration: 0.3, x: -distance });

            const pullX = Math.min(pivot.x - (1 / scale) * distance, 88);
            gsap.to("#bow polyline", {
              duration: 0.3,
              attr: { points: `88,200 ${pullX},250 88,300` },
            });

            const radius = distance * 9;
            const offset = {
              x: Math.cos(bowAngle) * radius,
              y: Math.sin(bowAngle) * radius,
            };
            const arcWidth = offset.x * 3;
            gsap.to("#arc", {
              duration: 0.3,
              attr: {
                d: `M100,250c${offset.x},${offset.y},${arcWidth - offset.x},${offset.y + 50
                  },${arcWidth},50`,
              },
              autoAlpha: distance / 60,
            });
          }

          function loose() {
            window.removeEventListener("mousemove", window.gameAimFn);
            window.removeEventListener("mouseup", window.gameLooseFn);
            window.removeEventListener("touchmove", window.gameAimFn);
            window.removeEventListener("touchend", window.gameLooseFn);

            if (prizeWon) return;

            playSound("shoot");

            gsap.to("#bow", {
              duration: 0.4,
              scaleX: 1,
              transformOrigin: "right center",
              ease: "elastic.out(1, 0.3)",
            });
            gsap.to("#bow polyline", {
              duration: 0.4,
              attr: { points: "88,200 88,250 88,300" },
              ease: "elastic.out(1, 0.3)",
            });

            const newArrow = document.createElementNS(
              "http://www.w3.org/2000/svg",
              "use"
            );
            newArrow.setAttributeNS(
              "http://www.w3.org/1999/xlink",
              "href",
              "#arrow"
            );
            arrowsGroup.appendChild(newArrow);

            gsap.to(newArrow, {
              duration: 0.6,
              ease: "none",
              motionPath: {
                path: "#arc",
                align: "#arc",
                alignOrigin: [0.5, 0.5],
                autoRotate: true,
              },
              onUpdate: function () {
                hitTest(this);
              },
              onComplete: () => showFeedback("ISKA!", "#95a5a6", false),
            });

            gsap.to("#arc", { duration: 0.3, opacity: 0 });
            gsap.set(".arrow-angle use", { opacity: 0 });
          }

          function hitTest(tween) {
            const arrow = tween.targets()[0];
            const x = gsap.getProperty(arrow, "x");
            const y = gsap.getProperty(arrow, "y");
            const rotation = gsap.getProperty(arrow, "rotation");

            const radians = (rotation * Math.PI) / 180;
            const arrowSegment = {
              x1: x,
              y1: y,
              x2: Math.cos(radians) * 60 + x,
              y2: Math.sin(radians) * 60 + y,
            };

            const intersection = getIntersection(arrowSegment, lineSegment);
            if (intersection && intersection.segment1 && intersection.segment2) {
              const dx = intersection.x - target.x;
              const dy = intersection.y - target.y;
              const distance = Math.sqrt(dx * dx + dy * dy);

              if (distance < 75) {
                tween.pause();
                arrow.setAttribute("clip-path", "url(#cut-arrow-tip)");

                score += 1;

                if (distance < 50) {
                  showFeedback("TAM Ä°SABET!", "#e74c3c", true);
                } else {
                  showFeedback("VURDUN!", "#f1c40f", true);
                }

                scoreEl.innerText = score;

                if (score >= 3 && !prizeWon) {
                  prizeWon = true;
                  setTimeout(() => {
                    playSound("win");
                    modalOverlay.style.display = "flex";
                    gsap.fromTo(
                      modalContent,
                      { scale: 0.5, opacity: 0 },
                      {
                        scale: 1,
                        opacity: 1,
                        duration: 0.5,
                        ease: "back.out(1.7)",
                      }
                    );
                  }, 1000);
                }
              }
            }
          }

          function showFeedback(text, color, isHit) {
            if (prizeWon) return;
            playSound(isHit ? "hit" : "miss");
            feedbackText.innerText = text;
            feedbackText.style.color = color;
            gsap.fromTo(
              feedbackText,
              { scale: 0, opacity: 0, rotation: -10 },
              {
                duration: 0.5,
                scale: 1.2,
                opacity: 1,
                rotation: 0,
                ease: "back.out(1.7)",
              }
            );
            gsap.to(feedbackText, {
              duration: 0.3,
              delay: 1,
              opacity: 0,
              scale: 0.5,
            });
          }

          function getMouseSVG(e) {
            let clientX, clientY;
            if (e.changedTouches && e.changedTouches.length > 0) {
              clientX = e.changedTouches[0].clientX;
              clientY = e.changedTouches[0].clientY;
            } else {
              clientX = e.clientX;
              clientY = e.clientY;
            }
            cursor.x = clientX;
            cursor.y = clientY;
            return cursor.matrixTransform(svg.getScreenCTM().inverse());
          }

          function getIntersection(segment1, segment2) {
            const dx1 = segment1.x2 - segment1.x1;
            const dy1 = segment1.y2 - segment1.y1;
            const dx2 = segment2.x2 - segment2.x1;
            const dy2 = segment2.y2 - segment2.y1;
            const cx = segment1.x1 - segment2.x1;
            const cy = segment1.y1 - segment2.y1;
            const denominator = dy2 * dx1 - dx2 * dy1;
            if (denominator == 0) return null;
            const ua = (dx2 * cy - dy2 * cx) / denominator;
            const ub = (dx1 * cy - dy1 * cx) / denominator;
            return {
              x: segment1.x1 + ua * dx1,
              y: segment1.y1 + ua * dy1,
              segment1: ua >= 0 && ua <= 1,
              segment2: ub >= 0 && ub <= 1,
            };
          }
        }
      }
    })();
  </script>
</body>

</html>